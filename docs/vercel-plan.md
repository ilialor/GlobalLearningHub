# План настройки Vercel для проекта GlobalLearningHub

## Текущие проблемы

Конфигурация Vercel в проекте в настоящее время некорректна, что приводит к ошибкам 404. Основные проблемы:

1. Несоответствие путей в конфигурации `vercel.json` с реальной структурой проекта
2. Отсутствие правильной настройки для обработки серверной части (API)
3. Несогласованность между скриптами сборки в `package.json` и требованиями Vercel

## Выполненные исправления

### 1. Обновление файла vercel.json ✅

Файл `vercel.json` обновлен в соответствии с актуальными требованиями Vercel и структурой проекта:

```json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist/public",
  "framework": "vite",
  "rewrites": [
    { "source": "/api/(.*)", "destination": "/api/index" },
    { "source": "/(.*)", "destination": "/" }
  ]
}
```

Это обновление заменяет устаревшую конфигурацию `builds` и `routes` на более современные параметры, которые лучше интегрируются с нативными возможностями Vercel.

### 2. Проверка скриптов сборки в package.json ✅

Текущий скрипт сборки: 
```
"build": "vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=api"
```

Скрипт корректный и обеспечивает:
1. Сборку клиентской части в директорию `dist/public` (настроено в `vite.config.ts`)
2. Сборку серверной части в директорию `api` с файлом `index.js` в формате ESM

### 3. Создание адаптера для Vercel Serverless Functions ✅

Создан файл `api/index.js` для адаптации Express-приложения к Vercel Serverless Functions:

```javascript
// Adapter for Vercel Serverless Functions
import app from '../server/index.js';

// Handler for Vercel serverless environment
export default app;
```

### 4. Проверка точки входа для серверной части ✅

Файл `server/index.ts` уже правильно экспортирует Express-приложение:

```typescript
// Экспорт приложения для Vercel
export default app;
```

### 5. Конфигурация переменных окружения

При деплое на Vercel необходимо настроить следующие переменные окружения через веб-интерфейс Vercel или CLI:

1. `OPENAI_API_KEY` - ключ для взаимодействия с OpenAI API
2. `DATABASE_URL` - строка подключения к PostgreSQL базе данных
3. `BLOB_READ_WRITE_TOKEN` - токен для работы с Vercel Blob Storage

Текущие значения в локальном `.env` файле:

```
BLOB_READ_WRITE_TOKEN="vercel_blob_rw_kieHYZME1axGktRr_asx5EZ8b76U6qyMor2lpW2fqPpmQTN"
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/postgres"
OPENAI_API_KEY="sk-proj-1234567890"
```

**Важно**: При создании проекта в Vercel следует использовать реальные значения для этих переменных.

### 6. Настройка базы данных для продакшена

Для установки PostgreSQL базы данных в продакшене:

1. Создать базу данных с помощью Neon, Supabase или другого провайдера PostgreSQL
2. Обновить переменную `DATABASE_URL` в настройках проекта в Vercel
3. При необходимости запустить миграции базы данных:
   ```
   npm run db:push
   ```

Для настройки хранилища файлов:
1. Создать токен в Vercel Blob Storage
2. Обновить переменную `BLOB_READ_WRITE_TOKEN` в настройках проекта в Vercel
3. При использовании Blob Storage в коде следовать документации Vercel:
   ```javascript
   import { put } from "@vercel/blob";
   
   const { url } = await put('articles/blob.txt', 'Hello World!', { access: 'public' });
   ```

## Оставшиеся шаги для завершения настройки

### 7. Проверка процесса сборки

1. Запустить сборку локально для проверки: 
   ```
   npm run build
   ```
2. Убедиться, что структура собранного проекта соответствует ожидаемой:
   - `dist/public/` содержит клиентские файлы
   - `api/index.js` успешно сгенерирован

### 8. Процесс деплоя на Vercel

Для деплоя проекта следуйте этим шагам:

1. Установить Vercel CLI:
   ```
   npm i -g vercel
   ```
2. Войти в аккаунт Vercel:
   ```
   vercel login
   ```
3. Выполнить первоначальный деплой:
   ```
   vercel
   ```
   Во время процесса деплоя Vercel CLI будет задавать вопросы о конфигурации проекта. Убедитесь, что:
   - Выбрана правильная команда сборки (`npm run build`)
   - Указана директория вывода (`dist/public`)
   - Настроены необходимые переменные окружения

4. Для настройки CI/CD:
   - Связать GitHub репозиторий с проектом Vercel через веб-интерфейс Vercel
   - Настроить автоматический деплой при пуше в main/master ветку

## Дополнительные рекомендации

### 1. Оптимизация серверного кода для Serverless

Serverless функции имеют определенные ограничения:
- Ограниченное время выполнения (до 10 секунд на Vercel)
- Ограничения на размер бандла (до 50 МБ)
- Cold start (холодный старт)

Рекомендации:
- Разделить большие API-эндпоинты на несколько функций
- Оптимизировать размер зависимостей (проанализировать с помощью `npm prune` и `npm dedupe`)
- Использовать кэширование где возможно (Vercel Edge Cache, Redis)

### 2. Статические активы и оптимизация

- Использовать Vercel Edge Network для кэширования статических ресурсов
- Настроить заголовки кэширования в `vercel.json`:
  ```json
  {
    "headers": [
      {
        "source": "/static/(.*)",
        "headers": [
          {
            "key": "Cache-Control",
            "value": "public, max-age=31536000, immutable"
          }
        ]
      }
    ]
  }
  ```
- Оптимизировать изображения с помощью Vercel Image Optimization API

### 3. Мониторинг и логирование

- Интегрировать с Vercel Analytics для мониторинга производительности
- Использовать структурированное логирование в серверных функциях
- Настроить алерты в Vercel на критические ошибки

## Заключение

Основные элементы настройки Vercel для проекта GlobalLearningHub успешно реализованы:
- ✅ Обновлен `vercel.json`
- ✅ Проверены скрипты сборки
- ✅ Создан адаптер для Serverless Functions
- ✅ Настроена точка входа серверной части

После выполнения оставшихся шагов (настройка переменных окружения и деплой) проект должен корректно работать на платформе Vercel без ошибок 404, так как все пути теперь настроены правильно для обработки клиентских и серверных запросов.
